# Zeek Mail Activity Demo

This repo keeps the minimum required assets to prove that Zeek can log both outbound mail delivery (SMTP) and inbound retrieval (POP3) in JSON format.

## Layout
```
.
├── pcaps/                # Sample captures for quick offline checks
│   ├── smtp-send.pcap    # Outbound SMTP session
│   └── pop3-receive.pcap # POP3 mailbox retrieval
├── scripts/              # Helper scripts for offline + live runs
│   ├── run-offline.sh
│   └── run-live.sh
├── zeek-scripts/
│   └── mail-activity-json.zeek
└── output/               # Logs generated by the helper scripts (gitignored)
    └── .gitignore
```

## 1. Offline verification
Run Zeek against the bundled captures—no network traffic required:

```bash
./scripts/run-offline.sh
# Logs -> output/offline/{smtp-send,pop3-receive}/mail_activity.log
```

Inspect the JSON:

```bash
jq '.["protocol", "activity", "mail_from", "rcpt_to", "user", "status"]' \
  output/offline/smtp-send/mail_activity.log | head
```

You should see entries such as `SMTP_MAIL`, `SMTP_RCPT`, `POP3_USER`, and `POP3_RETR`, confirming both send and receive workflows.

## 2. Live capture
Capture real traffic on an interface (requires root privileges). Example:

```bash
sudo ./scripts/run-live.sh en0
```

Environment variable `FILTER` can override the default BPF (`port 25 or port 465 or port 587 or port 110 or port 995`). Logs appear under `output/live-<timestamp>/mail_activity.log` and `output/live-<timestamp>/pop3.log` (POP3 logging is enabled by default).

## 3. Log format
`zeek-scripts/mail-activity-json.zeek` forces JSON output and writes a detailed `mail_activity.log` stream plus an optional `pop3.log` (enabled by default) with the fields below:

- `protocol`: `SMTP` or `POP3`
- `role`: `send` (SMTP client) or `receive` (POP3 client)
- `activity`: protocol command or server reply (e.g. `SMTP_MAIL`, `POP3_REPLY_OK`)
- `mail_from`, `rcpt_to`, `user`: key identifiers captured when present
- `status`, `detail`: response codes / textual context
- `ts`, `uid`, and Zeek connection identifiers for correlation
- `pop3.log`: captures each POP3 request/reply in a lightweight schema (`event`, `user`, `argument`, `status`, `detail`) to mirror the classic Zeek POP3 log; toggle with `redef MailActivity::enable_pop3_log=F` or change the filename via `redef MailActivity::pop3_log_path="pop"`.

## 4. Optional: Local test server
Need a fake mailbox? A minimal [GreenMail](https://www.icegreen.com/greenmail/) setup is included for SMTP + POP3.

```bash
docker compose -f docker/greenmail/docker-compose.yml up -d
# SMTP available at localhost:3025, POP3 at localhost:3110 (user demo/demo)
```

Keep `run-live.sh` running with the default filter to capture this traffic, then send mail via `localhost:3025` (e.g. `swaks`) and retrieve with any POP3 client against `localhost:3110`.

## 5. Notes
- Generated logs land in `output/` and are already ignored by Git.
- If you still have legacy files owned by `root` (e.g. older Zeek runs), remove them manually with `sudo rm` so the directory tree stays clean.
