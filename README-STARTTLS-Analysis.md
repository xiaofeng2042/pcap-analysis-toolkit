# SMTP STARTTLS 流量分析方案

## 概述

这是一套完整的STARTTLS场景下SMTP流量分析方案，能够在加密环境中"能采集多少就采集多少"，提供有价值的统计元数据。

## 核心思路

在STARTTLS场景下，虽然无法获取加密后的邮件正文，但仍能采集到：

### 握手前（明文部分）
- `EHLO/HELO` 握手信息
- `STARTTLS` 命令和服务器响应
- 服务器能力列表（如 `250-STARTTLS`）

### 握手后（TLS层元数据）
- TLS版本和密码套件
- 证书信息（颁发者、主题、有效期）
- 连接状态和字节统计
- 握手成功/失败状态

## 文件说明

### 核心脚本

1. **site-smtp-ports.zeek** - 端口注册脚本
   - 将非标准端口2525注册为SMTP分析器
   - 确保Zeek能识别并分析SMTP流量

2. **smtp-starttls-flag.zeek** - STARTTLS事件标记脚本
   - 监控SMTP STARTTLS命令
   - 标记TLS握手成功事件
   - 生成自定义通知日志

### 分析工具

3. **smtp-stats.sh** - 基础统计脚本（Bash版本）
   - 快速统计加密/非加密连接数量
   - 提供基本的时间线分析

4. **smtp-analysis-summary.py** - 详细分析脚本（Python版本）
   - 完整的流量分析报告
   - 详细的连接信息和时间线
   - 安全建议和统计摘要

## 使用方法

### 一键分析命令

```bash
# 进入分析目录
cd analysis/smtp2525-ssl

# 清理旧日志
rm -f *.log

# 运行Zeek分析（JSON格式输出）
zeek -Cr ../../smtp2525-ssl.pcapng ../../site-smtp-ports.zeek ../../smtp-starttls-flag.zeek LogAscii::use_json=T

# 运行统计分析
../../smtp-stats.sh

# 或运行详细分析
python3 ../../smtp-analysis-summary.py
```

### 生成的日志文件

- **smtp.log** - SMTP明文部分（握手前）
- **ssl.log** - TLS握手和加密信息
- **notice.log** - STARTTLS事件标记
- **x509.log** - 证书详细信息
- **conn.log** - 连接级统计信息

## 分析结果示例

```
=== SMTP流量统计分析 ===

1. 明文SMTP连接统计:
   总SMTP连接数: 1

2. TLS加密SMTP连接统计:
   TLS握手成功数: 1

3. STARTTLS事件统计:
   STARTTLS提供次数: 1
   STARTTLS成功次数: 1

4. 连接类型分析:
   加密连接 (明文→TLS): 1
   纯明文连接: 0
```

## 应用场景

### 生产环境监控
- 统计加密邮件传输比例
- 监控STARTTLS采用情况
- 识别未加密的邮件传输

### 安全审计
- 验证邮件服务器TLS配置
- 分析证书使用情况
- 检测异常连接模式

### 合规检查
- 确保邮件传输加密
- 生成加密传输报告
- 监控安全策略执行

## 扩展功能

### 按维度统计
可以基于现有脚本扩展，支持：
- 按时间窗口统计（小时/天/周）
- 按目的域名/IP统计
- 按证书颁发者统计
- 按TLS版本/密码套件统计

### 告警机制
- 检测到明文SMTP传输时告警
- TLS握手失败时告警
- 使用弱密码套件时告警

## 技术优势

1. **无需解密** - 不依赖私钥或密钥日志
2. **轻量级** - 基于Zeek标准功能，性能开销小
3. **实时分析** - 支持在线流量分析
4. **标准化输出** - JSON格式便于后续处理
5. **可扩展** - 易于集成到现有监控系统

## 注意事项

- 仅能分析握手前的明文SMTP内容
- 加密后的邮件正文、收发件人等信息无法获取
- 需要确保Zeek版本支持相关分析器
- 非标准端口需要手动注册

## 总结

这套方案在STARTTLS场景下实现了"能采集多少就采集多少"的目标，虽然无法获取加密内容，但提供的元数据足以支持：
- 加密传输统计
- 安全合规检查  
- 异常行为检测
- 性能监控分析